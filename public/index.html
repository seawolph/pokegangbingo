<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Bingo</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FF5252;
            --secondary: #3B4CCA;
            --accent: #FFCB05;
            --orange-txt: #E65100;
            --bg: #F4F6F8;
            --surface: #FFFFFF;
            --text-dark: #2C3E50;
            --text-light: #7F8C8D;
            --discord: #5865F2;
        }

        body { font-family: 'Nunito', sans-serif; background-color: var(--bg); color: var(--text-dark); text-align: center; margin: 0; padding: 0; }
        #app { max-width: 900px; margin: 0 auto; padding: 20px; min-height: 100vh; padding-bottom: 200px; }
        .hidden { display: none !important; }

        /* MUTE BUTTON */
        #mute-btn {
            position: fixed; top: 15px; right: 15px; z-index: 300;
            background: rgba(255,255,255,0.8); border: 2px solid var(--text-dark);
            border-radius: 50%; width: 40px; height: 40px; font-size: 20px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        h1 { color: var(--secondary); font-weight: 900; font-size: 3rem; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        .bingo-letter { color: var(--orange-txt); font-weight: 900; }
        .bingo-number { color: var(--secondary); font-weight: 900; }

        .card-container { background: var(--surface); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); padding: 40px; margin: 20px auto; max-width: 500px; transition: transform 0.3s ease; }

        input { width: 80%; padding: 15px; font-size: 18px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; outline: none; transition: 0.3s; font-family: 'Nunito', sans-serif; font-weight: 700; }
        input:focus { border-color: var(--secondary); }
        .code-input { text-transform: uppercase; letter-spacing: 5px; font-weight: 900; text-align: center; }
        
        select { width: 85%; padding: 15px; font-size: 18px; margin: 10px 0; border: 2px solid #eee; border-radius: 12px; font-family: 'Nunito', sans-serif; font-weight: 700; }

        button { padding: 15px 30px; font-size: 16px; font-weight: 800; border: none; cursor: pointer; border-radius: 50px; text-transform: uppercase; transition: transform 0.2s, box-shadow 0.2s; margin-top: 10px; }
        .btn-primary { background: var(--secondary); color: white; box-shadow: 0 4px 15px rgba(59, 76, 202, 0.4); }
        .btn-accent { background: var(--accent); color: var(--secondary); box-shadow: 0 4px 15px rgba(255, 203, 5, 0.4); }
        .btn-host { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(255, 82, 82, 0.4); }
        .btn-discord { background: var(--discord); color: white; text-decoration: none; display: inline-block; box-shadow: 0 4px 15px rgba(88, 101, 242, 0.4); }
        
        button:hover, .btn-discord:hover { transform: translateY(-3px); }
        button:active, .btn-discord:active { transform: translateY(1px); }

        .lobby-counter { font-size: 80px; font-weight: 900; color: var(--secondary); margin: 20px 0; }
        .lobby-subtext { color: var(--text-light); font-size: 18px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }

        #bingo-header { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 5px; }
        .header-cell { background: var(--primary); color: white; font-weight: 900; font-size: 24px; padding: 10px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }

        #bingo-card { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
        .bingo-cell { background: white; border-radius: 12px; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent; transition: all 0.2s; }
        .bingo-cell:hover { transform: scale(1.05); z-index: 2; box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .bingo-cell img { width: 75%; height: auto; transition: opacity 0.3s; }
        .bingo-cell span { font-size: 13px; font-weight: 800; color: var(--text-light); margin-top: 4px; letter-spacing: -0.5px; }
        
        .bingo-cell.marked:not(.free-space) { background-color: #FFF9C4; border-color: var(--accent); cursor: default; }
        .bingo-cell.marked:not(.free-space):hover { transform: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .bingo-cell.marked:not(.free-space)::after { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Pok%C3%A9_Ball_icon.svg/1024px-Pok%C3%A9_Ball_icon.svg.png'); background-size: 60%; background-repeat: no-repeat; background-position: center; opacity: 0.8; }
        .bingo-cell.marked:not(.free-space) img { opacity: 0.3; }
        .bingo-cell.free-space { background-color: #FFF9C4; border-color: var(--accent); cursor: default; }
        .bingo-cell.free-space img { opacity: 1; }

        #current-call { background: white; padding: 20px; margin-bottom: 20px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); border: 2px solid var(--secondary); display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 120px; }

        #bingo-btn { width: 100%; margin: 20px 0; padding: 20px; font-size: 28px; letter-spacing: 2px; background: linear-gradient(45deg, #FF5252, #FF1744); display: none; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); } 70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); } }

        #host-dashboard { display: grid; grid-template-columns: 350px 1fr; gap: 20px; text-align: left; }
        #master-board { display: grid; grid-template-columns: repeat(15, 1fr); gap: 2px; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .master-cell { font-size: 11px; background: #eee; text-align: center; padding: 4px 0; color: #aaa; border-radius: 4px; font-weight: 700; }
        .master-cell.called { background: var(--secondary); color: white; font-weight: bold; }

        #leaderboard { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); height: fit-content; }
        .player-row { border-bottom: 1px solid #f0f0f0; padding: 12px 0; display: flex; align-items: center; justify-content: space-between; }
        .player-info h4 { margin: 0; color: var(--text-dark); font-size: 16px; font-weight: 800; }
        .player-info p { margin: 0; color: var(--primary); font-weight: bold; font-size: 12px; }
        
        .mini-card { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1px; width: 50px; height: 50px; background: #eee; border-radius: 4px; overflow: hidden; }
        .mini-cell { background: white; width: 100%; height: 100%; }
        .mini-cell.marked { background: var(--accent); }

        /* WINNER SCREEN */
        #winner-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); color: white; z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #winner-screen.show { display: flex; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* BANNED SCREEN */
        #banned-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #FF5252; color: white; z-index: 500; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #banned-screen.show { display: flex; }

        /* VOTING MODAL */
        #vote-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 150; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #vote-modal.show { display: flex; animation: fadeIn 0.3s; }
        .vote-card { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; text-align: center; }
        .vote-timer { font-size: 40px; font-weight: 900; color: var(--primary); margin: 10px 0; }
        
        #vote-chart { display: flex; justify-content: space-around; align-items: flex-end; height: 200px; margin-top: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .chart-bar-container { display: flex; flex-direction: column; align-items: center; width: 15%; height: 100%; justify-content: flex-end; }
        .chart-bar { width: 100%; background: var(--secondary); border-radius: 8px 8px 0 0; transition: height 0.5s ease; min-height: 0px; }
        .chart-label { margin-top: 10px; font-weight: 900; font-size: 20px; color: var(--orange-txt); }
        .chart-count { font-size: 14px; color: #888; margin-bottom: 5px; font-weight: bold; }

        #vote-buttons { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .vote-btn { 
            width: 60px; height: 60px; border-radius: 50%; border: none; 
            font-size: 24px; font-weight: 900; color: white; cursor: pointer; 
            background: var(--secondary); transition: 0.2s; padding: 0;
            display: flex; justify-content: center; align-items: center; 
        }
        .vote-btn:hover { transform: scale(1.1); background: var(--primary); }

        /* CHAT SECTION */
        #chat-section {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: transparent;
            z-index: 200; 
            transition: transform 0.3s ease;
        }
        
        #chat-header {
            background: var(--secondary);
            color: white;
            padding: 8px 20px;
            font-weight: 900;
            border-radius: 15px 15px 0 0;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }

        #chat-content {
            background: white;
            padding: 10px;
            box-sizing: border-box;
        }

        #chat-section.minimized #chat-content { display: none; }

        #chat-messages {
            height: 80px; 
            overflow-y: auto; text-align: left; padding: 5px 10px;
            border: 1px solid #eee; border-radius: 10px; margin-bottom: 10px;
            background: #FAFAFA;
        }
        .chat-msg { margin-bottom: 4px; font-size: 13px; line-height: 1.4; }
        .chat-name { font-weight: 900; color: var(--secondary); margin-right: 5px; }
        .chat-host { color: var(--primary); }
        .chat-system { font-weight: 900; color: #E65100; font-style: italic; }
        .chat-alert { font-weight: 900; color: #FF0000; font-style: italic; background: #FFEBEE; padding: 2px 5px; border-radius: 4px; display: block; border: 1px solid red; }
        
        .chat-input-row { display: flex; gap: 10px; }
        #chat-input { margin: 0; flex-grow: 1; padding: 8px; font-size: 14px; }
        #chat-btn { margin: 0; padding: 8px 15px; font-size: 14px; min-width: 70px; }
        #chat-btn:disabled { background: #ccc; cursor: not-allowed; }

        .host-viewing .chat-name:not(.chat-host):hover {
            color: red !important;
            text-decoration: line-through;
            cursor: pointer;
        }

        /* Toast */
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: var(--text-dark); color: #fff; text-align: center; border-radius: 50px; padding: 16px; position: fixed; z-index: 200; left: 50%; bottom: 30px; opacity: 0; transition: opacity 0.5s, bottom 0.5s; font-weight: 700; }
        #toast.show { visibility: visible; opacity: 1; bottom: 50px; }
        #toast .bingo-letter { color: #FF9100; } 
        #toast .bingo-number { color: #4FC3F7; }

        @media (max-width: 900px) { 
            #host-dashboard { grid-template-columns: 1fr; } 
            #master-board { grid-template-columns: repeat(10, 1fr); }
            #app { padding-bottom: 200px; } 
        }
    </style>
</head>
<body>

<!-- Mute Button -->
<div id="mute-btn" onclick="toggleMute()">ðŸ”Š</div>

<div id="app">
    <h1>Pokemon Bingo</h1>

    <!-- Landing Screen -->
    <div id="landing-screen">
        <!-- HOST CARD -->
        <div class="card-container">
            <h3 style="color: var(--secondary);">Host a Game</h3>
            <input type="password" id="admin-pass" placeholder="Admin Password">
            <br>
            <button class="btn-host" onclick="createGame()">Create Session</button>
        </div>
        
        <!-- PLAYER CARD -->
        <div class="card-container">
            <h3 style="color: var(--primary);">Join a Game</h3>
            
            <!-- Default View: Show Login Button -->
            <div id="login-section">
                <p style="color: #666; margin-bottom: 20px;">Please log in to play.</p>
                <a href="/auth/discord" class="btn-discord" style="padding: 15px 30px; border-radius: 50px; font-weight: 800;">
                    Login with Discord
                </a>
            </div>

            <!-- Logged In View: Show Join Inputs -->
            <div id="join-section" class="hidden">
                <p id="welcome-msg" style="color: var(--secondary); font-weight: 800; font-size: 18px; margin-bottom: 10px;"></p>
                <input type="text" id="join-code" class="code-input" placeholder="Room Code">
                <br>
                <button class="btn-primary" onclick="joinGame()">Join Game</button>
                <div style="margin-top: 15px;">
                    <a href="/logout" style="color: #888; font-size: 12px; text-decoration: none;">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Lobby Screen -->
    <div id="lobby-screen" class="hidden">
        <div class="card-container">
            <h2 id="room-code-display" style="color: var(--text-dark); font-size: 32px; letter-spacing: 2px;"></h2>
            <div style="margin: 40px 0;">
                <div class="lobby-subtext">Players Joined</div>
                <div id="player-count-display" class="lobby-counter">0</div>
            </div>
            <p style="color: #888;">Waiting for host to start...</p>
            
            <div id="host-lobby-controls" class="hidden">
                <select id="game-mode">
                    <option value="standard">Standard (Line/Diagonal)</option>
                    <option value="coverall">Coverall (Blackout)</option>
                    <option value="corners">Four Corners</option>
                </select>
                <button class="btn-host" onclick="startGame()">Start Game (Lock Room)</button>
            </div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="hidden">
        <!-- HOST VIEW -->
        <div id="host-view" class="hidden">
            <div id="host-controls" style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <button class="btn-host" onclick="drawNumber()" style="padding: 15px 40px; font-size: 20px;">Draw Pokemon</button>
                <button class="btn-accent" onclick="startVote()" style="padding: 15px 40px; font-size: 20px;">Start Vote</button>
                <div id="host-current-call-display" style="display: flex; align-items: center; font-size: 24px; font-weight: 800; color: var(--secondary);">Ready?</div>
            </div>
            <div id="host-dashboard">
                <div id="leaderboard">
                    <h3 style="margin-top:0">Live Leaderboard</h3>
                    <div id="leaderboard-list">Waiting for start...</div>
                </div>
                <div>
                    <h3 style="margin-top:0">Master Board</h3>
                    <div id="master-board"></div>
                </div>
            </div>
        </div>

        <!-- PLAYER VIEW -->
        <div id="player-view" class="hidden">
            <div id="current-call">
                <div style="color: var(--text-light); text-transform: uppercase; font-size: 12px; font-weight: 800;">Current Call</div>
                <div id="called-display" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                    <span style="font-size: 24px; color: #ccc;">Waiting for host...</span>
                </div>
            </div>
            <button id="bingo-btn" class="btn-accent" onclick="claimBingo()">CLAIM BINGO!</button>
            <div style="max-width: 500px; margin: 0 auto;">
                <div id="bingo-header">
                    <div class="header-cell">B</div>
                    <div class="header-cell">I</div>
                    <div class="header-cell">N</div>
                    <div class="header-cell">G</div>
                    <div class="header-cell">O</div>
                </div>
                <div id="bingo-card"></div>
            </div>
            <div id="last-calls" style="margin-top:20px; color:#aaa; font-size: 14px; font-weight: 700;">History: None</div>
        </div>
    </div>
</div>

<!-- CHAT SECTION -->
<div id="chat-section" class="hidden">
    <div id="chat-header" onclick="toggleChat()">
        <span>ðŸ’¬ Chat</span>
        <span id="chat-toggle-icon">â–¼</span>
    </div>
    <div id="chat-content">
        <div id="chat-messages"></div>
        <div class="chat-input-row">
            <input type="text" id="chat-input" placeholder="Say something..." onkeypress="handleChatEnter(event)">
            <button id="chat-btn" class="btn-primary" onclick="sendChat()">Send</button>
        </div>
    </div>
</div>

<!-- VOTE MODAL -->
<div id="vote-modal">
    <div class="vote-card">
        <h2 style="margin:0; color:var(--text-dark)">Vote Next Letter!</h2>
        <div id="vote-timer" class="vote-timer">15</div>
        
        <div id="vote-buttons">
            <button class="vote-btn" onclick="submitVote('B')">B</button>
            <button class="vote-btn" onclick="submitVote('I')">I</button>
            <button class="vote-btn" onclick="submitVote('N')">N</button>
            <button class="vote-btn" onclick="submitVote('G')">G</button>
            <button class="vote-btn" onclick="submitVote('O')">O</button>
        </div>

        <div id="vote-chart">
            <div class="chart-bar-container"><div class="chart-count" id="count-B">0</div><div class="chart-bar" id="bar-B" style="height: 0%;"></div><div class="chart-label">B</div></div>
            <div class="chart-bar-container"><div class="chart-count" id="count-I">0</div><div class="chart-bar" id="bar-I" style="height: 0%;"></div><div class="chart-label">I</div></div>
            <div class="chart-bar-container"><div class="chart-count" id="count-N">0</div><div class="chart-bar" id="bar-N" style="height: 0%;"></div><div class="chart-label">N</div></div>
            <div class="chart-bar-container"><div class="chart-count" id="count-G">0</div><div class="chart-bar" id="bar-G" style="height: 0%;"></div><div class="chart-label">G</div></div>
            <div class="chart-bar-container"><div class="chart-count" id="count-O">0</div><div class="chart-bar" id="bar-O" style="height: 0%;"></div><div class="chart-label">O</div></div>
        </div>
    </div>
</div>

<!-- WINNER SCREEN -->
<div id="winner-screen">
    <div style="text-align: center;">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/151.png" style="width: 150px; margin-bottom: 20px;">
        <h1 style="font-size: 80px; color: var(--accent); margin: 0; line-height: 1;">BINGO!</h1>
        <h2 id="winner-name" style="font-size: 40px; margin: 10px 0;">Player Name</h2>
        <p style="font-size: 20px; opacity: 0.8;">Has won the game!</p>
        <br>
        <button class="btn-primary" onclick="location.reload()" style="background: white; color: var(--text-dark);">Play Again</button>
    </div>
</div>

<!-- BANNED SCREEN -->
<div id="banned-screen">
    <h1>YOU HAVE BEEN BANNED</h1>
</div>

<div id="toast"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myRoomCode = null;
    let calledNumbers = [];
    let myCardGrid = []; 
    let voteTimerInterval = null;
    let isHost = false;
    let isMuted = false;
    let currentGameMode = 'standard';
    let currentUserName = null; // Store fetched username

    // CHECK AUTH ON LOAD
    window.onload = function() {
        fetch('/auth/me')
            .then(res => res.json())
            .then(data => {
                if (data.user) {
                    // Logged in
                    currentUserName = data.user.username;
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('join-section').classList.remove('hidden');
                    document.getElementById('welcome-msg').innerText = `Welcome, ${currentUserName}`;
                } else {
                    // Not logged in
                    document.getElementById('login-section').classList.remove('hidden');
                    document.getElementById('join-section').classList.add('hidden');
                }
            })
            .catch(err => console.error("Auth check failed", err));
    };

    // --- AUDIO LOGIC ---
    function toggleMute() {
        isMuted = !isMuted;
        document.getElementById('mute-btn').innerText = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
        unlockAudio();
    }

    function unlockAudio() {
        const audio = new Audio();
        audio.play().catch(() => {});
    }

    function playCry(num) {
        if (isMuted) return;
        const audio = new Audio(`https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/${num}.ogg`);
        audio.volume = 0.5;
        audio.play().catch(e => console.log("Cry Play failed:", e));
    }

    function playWinSound() {
        if (isMuted) return;
        const audio = new Audio('https://github.com/PokeAPI/cries/raw/main/cries/pokemon/latest/151.ogg'); 
        const winAudio = new Audio('https://github.com/itsthatguy57/pokemon-sounds/raw/master/level_up.mp3');
        winAudio.volume = 0.6;
        winAudio.play().catch(e => console.log("Win sound failed:", e));
    }

    function getLocalClientID() {
        let id = localStorage.getItem('bingo_client_id');
        if (!id) {
            id = Math.random().toString(36).substring(2) + Date.now().toString(36);
            localStorage.setItem('bingo_client_id', id);
        }
        return id;
    }
    const myClientID = getLocalClientID();

    socket.on('connect', () => {
        if (myRoomCode) socket.emit('reconnect_session', { roomCode: myRoomCode, clientID: myClientID });
    });

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            if (myRoomCode && socket.connected) socket.emit('reconnect_session', { roomCode: myRoomCode, clientID: myClientID });
        }
    });

    function getBingoFormatted(num) {
        if (num === 151) return '<span style="color:var(--primary)">FREE</span>';
        let char = '';
        if (num <= 30) char = 'B';
        else if (num <= 60) char = 'I';
        else if (num <= 90) char = 'N';
        else if (num <= 120) char = 'G';
        else char = 'O';
        return `<span class="bingo-letter">${char}</span>-<span class="bingo-number">${num}</span>`;
    }

    function showToast(htmlMessage) {
        const toast = document.getElementById("toast");
        toast.innerHTML = htmlMessage; 
        toast.className = "show";
        setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
    }

    function initMasterBoard() {
        const board = document.getElementById('master-board');
        board.innerHTML = '';
        for(let i=1; i<=150; i++) {
            const div = document.createElement('div');
            div.className = 'master-cell';
            div.id = `master-${i}`;
            div.innerText = i;
            board.appendChild(div);
        }
    }

    function renderPlayerCard(cardGrid, markedNumbers = []) {
        myCardGrid = cardGrid; 
        const container = document.getElementById('bingo-card');
        container.innerHTML = '';
        cardGrid.forEach(row => {
            row.forEach(num => {
                const div = document.createElement('div');
                div.className = 'bingo-cell';
                div.id = `cell-${num}`; 
                div.dataset.number = num;
                const img = document.createElement('img');
                img.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${num}.png`;
                const span = document.createElement('span');
                span.innerHTML = getBingoFormatted(num);
                div.appendChild(img);
                div.appendChild(span);

                if (num === 151) {
                    div.classList.add('marked');
                    div.classList.add('free-space'); 
                } else if (markedNumbers.includes(num)) {
                    div.classList.add('marked');
                }
                if (num !== 151) div.onclick = () => handleCardClick(div, num);
                container.appendChild(div);
            });
        });
        checkLocalBingo();
    }

    function handleCardClick(element, number) {
        if (element.classList.contains('marked')) return;
        if (calledNumbers.includes(number)) {
            element.classList.add('marked');
            socket.emit('mark_number', { roomCode: myRoomCode, number: number, isMarking: true });
            checkLocalBingo();
        } else {
            showToast(`${getBingoFormatted(number)} hasn't been called yet!`);
        }
    }

    function checkLocalBingo() {
        let hasBingo = false;

        if (currentGameMode === 'coverall') {
            let allMarked = true;
            for (let r = 0; r < 5; r++) {
                for (let c = 0; c < 5; c++) {
                    const num = myCardGrid[r][c];
                    if (num !== 151) {
                        const el = document.getElementById(`cell-${num}`);
                        if (!el || !el.classList.contains('marked')) {
                            allMarked = false;
                            break;
                        }
                    }
                }
                if (!allMarked) break;
            }
            hasBingo = allMarked;
        } 
        else if (currentGameMode === 'corners') {
            const corners = [myCardGrid[0][0], myCardGrid[0][4], myCardGrid[4][0], myCardGrid[4][4]];
            const isMarked = (n) => document.getElementById(`cell-${n}`).classList.contains('marked');
            if (corners.every(isMarked)) hasBingo = true;
        } 
        else {
            const isMarked = (num) => {
                if(num === 151) return true;
                const el = document.getElementById(`cell-${num}`);
                return el && el.classList.contains('marked');
            };
            const checkLine = (line) => line.every(num => isMarked(num));
            for (let r = 0; r < 5; r++) if (checkLine(myCardGrid[r])) hasBingo = true;
            for (let c = 0; c < 5; c++) {
                const col = [myCardGrid[0][c], myCardGrid[1][c], myCardGrid[2][c], myCardGrid[3][c], myCardGrid[4][c]];
                if (checkLine(col)) hasBingo = true;
            }
            if(checkLine([myCardGrid[0][0], myCardGrid[1][1], myCardGrid[2][2], myCardGrid[3][3], myCardGrid[4][4]])) hasBingo = true;
            if(checkLine([myCardGrid[0][4], myCardGrid[1][3], myCardGrid[2][2], myCardGrid[3][1], myCardGrid[4][0]])) hasBingo = true;
        }

        const btn = document.getElementById('bingo-btn');
        btn.style.display = hasBingo ? 'block' : 'none';
    }

    function claimBingo() { socket.emit('claim_bingo', myRoomCode); }
    function createGame() {
        const pass = document.getElementById('admin-pass').value;
        if(!pass) return showToast("Enter Admin Password");
        unlockAudio(); 
        socket.emit('create_game', { password: pass, clientID: myClientID });
    }
    
    // UPDATED JOIN
    function joinGame() {
        // No input reading, use currentUserName
        if(!currentUserName) return showToast("Please login first");
        const code = document.getElementById('join-code').value.toUpperCase();
        if(!code) return showToast("Enter room code");
        unlockAudio(); 
        socket.emit('join_game', { roomCode: code, name: currentUserName, clientID: myClientID });
    }

    function startGame() { 
        const mode = document.getElementById('game-mode').value;
        socket.emit('start_game', { roomCode: myRoomCode, mode: mode }); 
    }
    function drawNumber() { socket.emit('draw_number', myRoomCode); }
    
    function startVote() { socket.emit('start_vote', myRoomCode); }
    function submitVote(letter) {
        socket.emit('submit_vote', { roomCode: myRoomCode, letter, clientID: myClientID });
        document.getElementById('vote-buttons').classList.add('hidden');
    }

    function toggleChat() {
        const section = document.getElementById('chat-section');
        const icon = document.getElementById('chat-toggle-icon');
        section.classList.toggle('minimized');
        icon.innerText = section.classList.contains('minimized') ? 'â–²' : 'â–¼';
    }

    function handleChatEnter(e) { if(e.key === 'Enter') sendChat(); }
    
    function sendChat() {
        const input = document.getElementById('chat-input');
        const btn = document.getElementById('chat-btn');
        const msg = input.value.trim();
        if (!msg) return;

        socket.emit('send_chat', { roomCode: myRoomCode, message: msg, clientID: myClientID });
        input.value = '';

        btn.disabled = true;
        let cd = 10;
        btn.innerText = cd;
        const interval = setInterval(() => {
            cd--;
            btn.innerText = cd;
            if(cd <= 0) {
                clearInterval(interval);
                btn.disabled = false;
                btn.innerText = 'Send';
            }
        }, 1000);
    }

    function appendChatMessage(msg) {
        const container = document.getElementById('chat-messages');
        const div = document.createElement('div');
        div.className = 'chat-msg';
        
        if (msg.isAlert) {
            div.innerHTML = `<span class="chat-alert">${msg.text}</span>`;
        } else if (msg.isSystem) {
            div.innerHTML = `<span class="chat-system">${msg.text}</span>`;
        } else {
            const nameClass = msg.isHost ? 'chat-name chat-host' : 'chat-name';
            const nameSpan = document.createElement('span');
            nameSpan.className = nameClass;
            nameSpan.innerText = msg.name + ': ';
            
            if (isHost && !msg.isHost) {
                nameSpan.title = "Click to BAN " + msg.name;
                nameSpan.onclick = function() { confirmBan(msg.clientID, msg.name); };
            }

            const textSpan = document.createElement('span');
            textSpan.innerText = msg.text;

            div.appendChild(nameSpan);
            div.appendChild(textSpan);
        }
        
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function confirmBan(targetID, targetName) {
        if(confirm(`Are you sure you want to BAN ${targetName}?`)) {
            socket.emit('ban_player', { roomCode: myRoomCode, targetClientID: targetID });
        }
    }

    // --- SOCKET LISTENERS ---

    socket.on('game_created', (data) => {
        let code = typeof data === 'string' ? data : data.roomCode;
        myRoomCode = code;
        isHost = true;
        document.body.classList.add('host-viewing');
        document.getElementById('landing-screen').classList.add('hidden');
        document.getElementById('lobby-screen').classList.remove('hidden');
        document.getElementById('host-lobby-controls').classList.remove('hidden'); 
        document.getElementById('room-code-display').innerText = `${code}`;
        document.getElementById('chat-section').classList.remove('hidden'); 
        initMasterBoard();
        
        document.getElementById('chat-messages').innerHTML = ''; 
        if(data.chatHistory) data.chatHistory.forEach(appendChatMessage);
    });

    socket.on('joined_success', (data) => {
        myRoomCode = data.roomCode;
        isHost = false;
        if(data.gameMode) currentGameMode = data.gameMode; 

        document.body.classList.remove('host-viewing');
        document.getElementById('landing-screen').classList.add('hidden');
        document.getElementById('lobby-screen').classList.remove('hidden');
        document.getElementById('room-code-display').innerText = `${data.roomCode}`;
        document.getElementById('chat-section').classList.remove('hidden'); 
        renderPlayerCard(data.card, data.markedNumbers);

        document.getElementById('chat-messages').innerHTML = ''; 
        if(data.chatHistory) data.chatHistory.forEach(appendChatMessage);
    });

    socket.on('chat_message', (msg) => { appendChatMessage(msg); });
    
    socket.on('chat_history_update', (history) => {
        document.getElementById('chat-messages').innerHTML = '';
        history.forEach(appendChatMessage);
    });

    socket.on('banned', () => {
        document.getElementById('app').classList.add('hidden');
        document.getElementById('chat-section').classList.add('hidden');
        document.getElementById('banned-screen').classList.add('show');
    });

    socket.on('player_count_update', (count) => { document.getElementById('player-count-display').innerText = count; });
    socket.on('error_msg', (msg) => showToast(msg));

    socket.on('game_started', (mode) => {
        if(mode) currentGameMode = mode;
        document.getElementById('lobby-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        if (isHost) document.getElementById('host-view').classList.remove('hidden');
        else document.getElementById('player-view').classList.remove('hidden');
    });

    socket.on('number_drawn', (data) => {
        if (data.history) calledNumbers = data.history;
        else {
            calledNumbers.push(data.number);
            playCry(data.number);
        }
        const num = data.number;
        const formattedHTML = getBingoFormatted(num);
        document.getElementById('called-display').innerHTML = `<div style="font-size:50px; line-height:1;">${formattedHTML}</div><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${num}.png" style="width:100px">`;
        const historyHTML = calledNumbers.slice(-5).map(n => getBingoFormatted(n)).join(', ');
        document.getElementById('last-calls').innerHTML = "History: " + historyHTML;
        document.getElementById('host-current-call-display').innerHTML = `<span style="font-size: 40px; margin-right: 15px;">${formattedHTML}</span><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${num}.png" style="height: 80px; vertical-align: middle;">`;
        if (data.history) data.history.forEach(n => { const cell = document.getElementById(`master-${n}`); if(cell) cell.classList.add('called'); });
    });

    socket.on('host_update', (data) => {
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = '';
        data.topPlayers.forEach(p => {
            const row = document.createElement('div');
            row.className = 'player-row';
            const info = document.createElement('div');
            info.className = 'player-info';
            info.innerHTML = `<h4>${p.name}</h4><p>${p.toGo} to go</p>`;
            const mini = document.createElement('div');
            mini.className = 'mini-card';
            p.card.forEach(cardRow => {
                cardRow.forEach(val => {
                    const dot = document.createElement('div');
                    dot.className = 'mini-cell';
                    if (val === 151) dot.classList.add('free');
                    if (p.markedNumbers.includes(val) || val === 151) dot.classList.add('marked');
                    mini.appendChild(dot);
                });
            });
            row.appendChild(info);
            row.appendChild(mini);
            list.appendChild(row);
        });
    });

    socket.on('game_over', (winnerName) => {
        playWinSound(); 
        document.getElementById('winner-name').innerText = winnerName;
        document.getElementById('winner-screen').classList.add('show');
    });

    socket.on('vote_started', (data) => {
        const modal = document.getElementById('vote-modal');
        const btns = document.getElementById('vote-buttons');
        const timer = document.getElementById('vote-timer');
        
        if(!data.counts) {
            ['B','I','N','G','O'].forEach(l => {
                document.getElementById(`count-${l}`).innerText = '0';
                document.getElementById(`bar-${l}`).style.height = '0%';
            });
        } else {
            const max = Math.max(...Object.values(data.counts));
            ['B','I','N','G','O'].forEach(l => {
                const count = data.counts[l];
                document.getElementById(`count-${l}`).innerText = count;
                const h = max > 0 ? (count / max) * 100 : 0;
                document.getElementById(`bar-${l}`).style.height = `${h}%`;
            });
        }

        modal.classList.add('show');
        if (isHost || (data.hasVoted)) btns.classList.add('hidden');
        else btns.classList.remove('hidden');

        if(voteTimerInterval) clearInterval(voteTimerInterval);
        
        function updateTimer() {
            const now = Date.now();
            const remaining = Math.max(0, Math.ceil((data.endTime - now) / 1000));
            timer.innerText = remaining;
            if(remaining <= 0) clearInterval(voteTimerInterval);
        }
        
        updateTimer();
        voteTimerInterval = setInterval(updateTimer, 1000);
    });

    socket.on('vote_update', (counts) => {
        const max = Math.max(...Object.values(counts));
        ['B','I','N','G','O'].forEach(l => {
            const count = counts[l];
            document.getElementById(`count-${l}`).innerText = count;
            const h = max > 0 ? (count / max) * 100 : 0;
            document.getElementById(`bar-${l}`).style.height = `${h}%`;
        });
    });

    socket.on('vote_ended', () => {
        document.getElementById('vote-modal').classList.remove('show');
        if(voteTimerInterval) clearInterval(voteTimerInterval);
    });

</script>
</body>
</html>
